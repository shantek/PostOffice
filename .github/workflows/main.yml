name: PostOffice â€“ Auto Build & Release with Build Number

on:
  push:
    branches: [master]

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      release_exists: ${{ steps.check_release.outputs.exists }}
      build_number: ${{ steps.read_build.outputs.number }}
      tag_build_number: ${{ steps.read_build.outputs.tag_number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read build number
        id: read_build
        run: |
          BUILD=$(cat build.number)
          echo "number=$BUILD" >> $GITHUB_OUTPUT
          echo "tag_number=$(echo "$BUILD" | tr '.' '_')" >> $GITHUB_OUTPUT

      - name: Check if release already exists (authoritative)
        id: check_release
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          TAG="build-${{ steps.read_build.outputs.tag_number }}"

          if gh release view "$TAG" --repo "${{ github.repository }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release $TAG already exists â€” skipping build."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No release found â€” proceeding with build."
          fi

  build:
    needs: check
    if: ${{ needs.check.outputs.release_exists == 'false' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 16

      - name: Build project
        run: mvn package -B

      - name: Rename JAR to include build number
        run: |
          mv target/PostOffice*.jar \
             target/PostOffice-build-${{ needs.check.outputs.build_number }}.jar

      - name: Generate changelog
        run: |
          git fetch --tags
          LAST_TAG=$(git describe --tags --abbrev=0 $(git rev-list --tags --max-count=1) 2>/dev/null || echo "")
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          git log $LAST_TAG..HEAD --pretty=format:"- %s" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ needs.check.outputs.tag_build_number }}
          name: Release ${{ needs.check.outputs.build_number }}
          body: ${{ env.CHANGELOG }}
          files: target/PostOffice-build-${{ needs.check.outputs.build_number }}.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      # ðŸ§¯ Discord sometimes closes the connection early (ECONNRESET)
      # This prevents a false failure while still posting successfully
      - name: Notify Discord
        continue-on-error: true
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          filename: target/PostOffice-build-${{ needs.check.outputs.build_number }}.jar
          embed-title: "ðŸ“¦ PostOffice â€“ Build #${{ needs.check.outputs.build_number }}"
          embed-description: |
            **Plugin:** PostOffice  
            **Build:** `${{ needs.check.outputs.build_number }}`

            **Changelog:**
            ${{ env.CHANGELOG }}

            âœ… Build completed successfully!
          embed-color: 3066993
          embed-thumbnail-url: https://cdn.modrinth.com/data/9mkWBW5N/79bf8c49a51efa2176517f4f9743aa6a57d3927b_96.webp
          embed-footer-text: "PostOffice â€¢ Direct File Upload"